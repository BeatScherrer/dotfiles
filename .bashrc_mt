#!/usr/bin/bash

# TODO fix these colors, they pollute all sorts of stuff
# source "$HOME/.scripts/log.bash"

workspace="${HOME}/workspace"

#aliases
if [[ -f "${HOME}/.aliases_mt" ]]; then
  source "${HOME}/.aliases_mt"
fi

# Helper function to change to git dir
ccd() {
  cd "$workspace/mtrsys/${1:-develop}/" || return 1
}

cducc() {
  cd "$workspace/ucc/${1:-development}" || return 1
}

cdclient() {
  cd "$workspace/ucc/${1-development}/src/MTRobot.UCC/src/MTRobot.UCC.Presentation.Web/ucc-client" || exit
}

# Helper function to change to a particular build directory
cdbuild() {
  ccd "$1" && cd build || return 1
}

# Helper function to change to a particular source directory
cdsrc() {
  if [[ -z "$1" ]];then
    cd "$HOME/src"
  else
    ccd "$1" && cd src || return 1
  fi
}

# submodule navigation helper
cds() {
  cd "$1" || return 1
}
_cds() {
  COMPREPLY=()
  cur=${COMP_WORDS[$COMP_CWORD]}
  declare -a submdodules
  submodules="$(git submodule 2>/dev/null | awk '{print $2}' | grep "^$cur" || echo '')"
  COMPREPLY=($(compgen -W '$submodules' -- ''))
}
complete -F _cds cds

sourceros() {
  echo "sourcing ros"
  source /opt/ros/melodic/setup.bash
  #echo "setting ROS_MASTER_URI=http:10.0.52.114:11311/"
  #export ROS_MASTER_URI=http://10.0.52.114:11311/
  #export ROS_IP=10.0.20.244
  export TURTLEBOT3_MODEL=burger

  if [[ -f "$HOME/workspace/ros_ws/devel/setup.bash" ]]; then
    echo "sourcing ros_ws"
    source "$HOME/workspace/ros_ws/devel/setup.bash"
  fi

  alias tf='cd /var/tmp && rosrun tf view_frames && evince frames.pdf &'
}

# source ros automatically if present
if [[ -f "/opt/ros/melodic/setup.bash" ]]; then
  sourceros
fi

sourcerti6() {
  echo "sourcing rti_connext_dds-6.1.0"
  source "/opt/rti_connext_dds-6.1.0/resource/scripts/rtisetenv_x64Linux4gcc7.3.0.bash"
}

sourcerti7() {
  echo "sourcing rti_connext_dds-7.0.0"
  source "/opt/rti_connext_dds-7.0.0/resource/scripts/rtisetenv_x64Linux4gcc7.3.0.bash"

}

#
#  ccache
if [[ -n "$SCHROOT_GID" ]]; then
  export PATH=/usr/lib/ccache:$PATH
  export CC="ccache gcc"
  export CXX="ccache g++"
  export CCACHE_BASEDIR="/home/beat/workspace/mtr_sys"
  export DISPLAY=:0
fi

__make() {
  filename="/tmp/nvim_quickfix.log"
  cd build && schroot -c chroot:mt_ubuntu18 -- make "$@" |& tee "$filename"
}

# add RTI tools to path if present
if [[ -d "/opt/rti_connext_dds-7.0.0/bin" ]]; then
  export PATH="/opt/rti_connext_dds-7.0.0/bin:$PATH"
elif [[ -d "/opt/rti_connext_dds-6.1.0/bin" ]]; then
  export PATH="/opt/rti_connext_dds-6.1.0/bin:$PATH"
fi

cleanws() {
  if [[ -d "build" && -d "install" && -d "log" ]]; then
    rm -rf build install log
  fi
}

sshr() {
  ssh -X "mtr@robot-$1.mt"
}

sshv() {
  declare -r arg="$1"
  local disp="0"
  [[ -z "$arg" ]] && echo "usage: mssh <host>" && return 1
  local server="${arg}"
  [[ -n "${2-}" ]] && disp="$2"
  ssh -t -f -L 5900:localhost:5900 "mtr@$server" "x11vnc -auth guess -localhost -display :$disp" &>/dev/null
  sleep 2
  vncviewer localhost:5900
}

sshm() {
  ssh "mtr@ms-$1.mt"
}

mt-rti-spy() {
  mt-spy -topicRegex "$1" -printSample
}

####################
# UCC functionality
####################
cleanbuild() {
  dotnet nuget locals all -c # when nuget package changed with the same version, generally unneeded
  dotnet restore
  dotnet clean # generally unneeded
  dotnet build
}

nugetPushIDLStorageV() {
  if [[ -z "${1-}" ]]; then
    echo "usage: nugetPushIDLStorageV: <version>" 1>&2
    return 1
  fi
  nuget push "MTRobot.UCC.Data.IDLStorage*$1*.nupkg" -Source http://ms-build.mt/nuget -apiKey '5a742973-dd02-464c-9da0-52ded9e74a8b'
}

nugetList() {
  nuget list IDLStorage -source http://ms-build.mt/nuget -AllVersions -PreRelease
}

nugetDeleteIDLStorageV ()
{
    if [[ -z "${1-}" ]]; then
        echo "usage: nugetDeleteIDLStorageV: <version>" 1>&2;
        return 1;
    fi;
    nuget delete MTRobot.UCC.Data.IDLStorage -Source http://ms-build.mt/nuget -apiKey '5a742973-dd02-464c-9da0-52ded9e74a8b' "$1";
    nuget delete MTRobot.UCC.Data.IDLStorageXML -Source http://ms-build.mt/nuget -apiKey '5a742973-dd02-464c-9da0-52ded9e74a8b' "$1"
}

## @fn coredumpgdb()
## coredumpctl debug a dump created inside a schroot or systemd container
## @param id the coredumpctl list pid
coredumpgdb() {
  local id="$1"
  local info schroot bin bin_path build_path args
  info="$(coredumpctl info "$id")"
  schroot="$(grep Executable <<<"$info" | grep -oP "(?<=mount/)[^-]*" ||
    grep Unit <<<"Unit: machine-ub22.scope" | grep -oP "[^-]*(?=.scope)")"
  bin="$(grep Executable <<<"$info" | rev | cut -d'/' -f1 | rev)"
  build_path="$(grep Executable <<<"$info" | grep -o '/home.*/build')"
  bin_path="$(find "$build_path" ! -path "*live_env*" -name "$bin" | tail -n1)"
  args=" -q -ex 'set confirm off' -ex 'set sysroot /srv/chroot/$schroot' -ex 'set debug-file-directory $build_path' -ex 'file $bin_path'"
  echo "Running: coredumpctl debug '$id' --debugger-arguments='$args'" 1>&2
  coredumpctl debug "$id" --debugger-arguments="$args"
}

viewDot() {
  local file="$1"
  local dot_temp
  dot_temp="$(mktemp).png"

  dot -Tpng "$file" > "$dot_temp"
  DISPLAY=:0 xdg-open "$dot_temp"
}

